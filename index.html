<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakamichi Sort</title>
    <!--引用bootstrap5 css -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!--引用bootstrap5 js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>
    <!--引用jQuery3.6.3 js -->
    <script src="https://code.jquery.com/jquery-3.6.3.js"
        integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <style>
        /* The sidebar menu */
        .sidebar {
            height: 100%;
            /* 100% Full-height */
            width: 0;
            /* 0 width - change this with JavaScript */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Stay on top */
            top: 0;
            left: 0;
            background-color: #7d2982;
            /* Black*/
            overflow-x: hidden;
            /* Disable horizontal scroll */
            padding-top: 60px;
            /* Place content 60px from the top */
            transition: 0.5s;
            /* 0.5 second transition effect to slide in the sidebar */
        }

        /* The sidebar links */
        .sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        /* When you mouse over the navigation links, change their color */
        .sidebar a:hover {
            color: #f1f1f1;
        }

        /* Position and style the close button (top right corner) */
        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        /* The button used to open the sidebar */
        .openbtn {
            font-size: 20px;
            cursor: pointer;
            background-color: #7d2982;
            color: white;
            padding: 10px 15px;
            border: none;
        }

        .openbtn:hover {
            background-color: #7d2982;
        }

        button:disabled {
            background-color: #e2bcbc !important;
        }

        /* Style page content - use this if you want to push the page content to the right when you open the side navigation */
    </style>
</head>

<body>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="./index.html?group=n46">Home</a>
        <a href="./index.html?group=n46">Nogizaka46</a>
        <a href="./index.html?group=s46">Sakurazaka46</a>
        <a href="./index.html?group=h46">Hinatazaka46</a>
        <a href="./index.html?group=fa">Fubon Angels</a>
        <a href="./index.html?group=rg">Rakuten Girls</a>
        <a href="./index.html?group=ps">Passion Sisters</a>
    </div>

    <div id="main" class="container-fluid  border-bottom border-dark border-3" style="background-color: #7d2982">
        <button class="openbtn" onclick="openNav()">&#9776; Sakamichi Sorter</button>
    </div>

    <div id="initialize" class="container">
        <h1 id="group_title" class="text-center" style="color: plum;">Nogizaka46</h1>
        <h1 class="text-center" id="h1_people">你已經選擇0人</h1>
    </div>
    <div id="content"></div>
    <div id="result"></div>

    <!-- 按鈕區域 -->
    <div class="button-area" style="text-align: center; margin-top: 20px;">
        <button id="startButton" disabled style="
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #6c5ce7;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        " onclick="Game_start()">
            開始
        </button>
    </div>
    </div>



    <script>
        var idol_list = [];
        let choose_member = [];
        let round = 1;
        let matches = [];
        let currentMatchIndex = 0;

        let initialize_html = '';
        let content_html = '';
        let result_html = '';
        var need_play_around;

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            let group = urlParams.get('group') || 'n46';

            console.log("從 URL 參數獲取的值:");
            console.log("團體:", group);
            if (group == 'n46') {
                $("#group_title").text('Nogizaka46');
                $("#main,.openbtn,.sidebar").css('background-color', "purple")
                $("#group_title").css('color', 'purple')
            }
            else if (group == 's46') {
                $("#group_title").text('Sakurazaka46');
                $("#main,.openbtn,.sidebar").css('background-color', "pink")
                $("#group_title").css('color', 'pink')


            }
            else if (group == 'h46') {
                $("#group_title").text('Hinatazaka46');
                $("#main,.openbtn,.sidebar").css('background-color', "cyan")
                $("#group_title").css('color', 'cyan')
                $(".openbtn").css('color', 'black');

            }
            else if (group == 'rg') {
                $("#group_title").text('Rakuten Girls');
                $("#main,.openbtn,.sidebar").css('background-color', "red")
                $("#group_title").css('color', 'red')
                $(".openbtn").css('color', 'black');
            }
            else if (group == 'fa') {
                $("#group_title").text('Fubon_Angels');
                $("#main,.openbtn,.sidebar").css('background-color', "cyan")
                $("#group_title").css('color', 'cyan')
                $(".openbtn").css('color', 'black');
            }
            else if (group == 'ps') {
                $("#group_title").text('Passion Sister');
                $("#main,.openbtn,.sidebar").css('background-color', "yellow")
                $("#group_title").css('color', 'yellow')
                $(".openbtn").css('color', 'black');
            }


            let group_url = `./json/${group}.json`;
            fetch(group_url)
                .then(Response => Response.json())
                .then(data => {
                    console.log(data);
                    idol_list = data;

                    console.log(idol_list);


                    $("#content,#result").hide();
                    initialize_html += `<div class="accordion accordion-flush" id="accordionFlushExample">
    `;
                    idol_list.forEach((gen, index) => {
                        console.log(gen, index);
                        initialize_html += `
        <div class="accordion-item">
                    <h2 class="accordion-header d-flex" id="flush-heading${index}">
                        <span class="d-flex align-items-center" onclick="event.stopPropagation();">
                            <input type="checkbox" class="me-2" id="${gen[0].En_Gen}" onchange='Generation_change("${gen[0].En_Gen}")'>
                            <label for="${gen[0].En_Gen}" class="mb-0">${gen[0].Generation}</label>
                        </span>
                        <button class="accordion-button collapsed" style="width:80%" type="button" data-bs-toggle="collapse"
                        data-bs-target="#flush-collapse${index}" aria-expanded="false" aria-controls="flush-collapse${index}">
                        

                        </button>
                    </h2>
                    <div id="flush-collapse${index}" class="accordion-collapse collapse" aria-labelledby="flush-heading${index}"
                        data-bs-parent="#accordionFlushExample">
                        `

                        for (let i = 1; i < gen.length; i++) {
                            initialize_html += `
                    <div class="accordion-body">
                        <input type="checkbox" name="" id="${gen[i].En_Name}">    
                        <label for="${gen[i].En_Name}">${gen[i].Name}</label>                    
                    </div>
                    `
                        }

                        initialize_html += `</div></div>`

                    })


                    initialize_html += `
            </div>
        `;

                    $("#initialize").append(initialize_html);

                    $("input").change(function () {
                        $('#h1_people').text(`你已經選擇${member_choose()}人`)
                        if (member_choose() >= 5) {
                            $('#startButton').prop('disabled', false); // 啟用按鈕
                        } else {
                            $('#startButton').prop('disabled', true); // 禁用按鈕
                        }
                    })
                })
        });
        function Generation_change(gen) {//處理選擇期別全選

            console.log(gen);
            let gen_checked = $(`#${gen}`).prop('checked');
            console.log(gen_checked);
            let gen_idx = 0;
            while (idol_list[gen_idx][0].En_Gen != gen) {
                gen_idx++;
            }
            console.log(gen_idx);

            idol_list[gen_idx].forEach(member => {
                if (!gen_checked) {
                    $(`#${member.En_Name}`).prop('checked', false);
                }
                else {
                    $(`#${member.En_Name}`).prop('checked', true);

                }
            });


        }
        function member_choose() {//計算選擇幾個成員
            let been_choose = 0;
            idol_list.forEach(gen => {
                for (let index = 1; index < gen.length; index++) {
                    if ($(`#${gen[index].En_Name}`).prop('checked')) {
                        been_choose++;
                    }
                }
            })
            return been_choose;
        }
        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]]; // swap
            }
        }
        function displayMatch() {
            if (currentMatchIndex >= matches.length) {
                round++;
                startRound();
                return;
            }
            need_play_around = Math.max(1, Math.ceil(getBaseLog(2, member_choose()) + 2));

            let [idol1, idol2] = matches[currentMatchIndex];
            let count = ((round - 1) * Math.floor(choose_member.length / 2.0) + currentMatchIndex + 1)
            let percent = count / (need_play_around * (choose_member.length / 2)) * 100
            console.log(matches, currentMatchIndex);

            content_html = `
            <div class="container result-box p-3">

            <!-- 編號與進度條 -->
            <div class="text-center mb-2">No.${count}</div>
            ${percent.toFixed(2)}%
            <div class="progress mb-2" style="height: 20px;">
                <div class="progress-bar" role="progressbar" style="width: ${percent}%;" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">
                </div>
            </div>

            <!-- 成員資訊與圖片 -->
            <div class="row ">
                <div class="col-md-6 text-center">
                    <div>${idol1.Name}</div>
                    <img src="${idol1.img}" class=" mt-2 mb-3" style="width:300px" alt="${idol1.Name}"  onclick="selectWin('${idol1.En_Name}','${idol2.En_Name}',1)">
                </div>
                <div class="col-md-6 text-center">
                    <div>${idol2.Name}</div>
                    <img src="${idol2.img}" class=" mt-2 mb-3" style="width:300px" alt="${idol2.Name}"  onclick="selectWin('${idol1.En_Name}','${choose_member[1].En_Name}',2)">
                </div>
            </div>

            <!-- 選擇按鈕 -->
            <div class="row text-center mt-3">
                <div class="col-12">
                    <button class="btn btn-light vote-btn border" onclick="selectWin('${idol1.En_Name}','${idol2.En_Name}',0)">平手</button>
                </div>
            </div>
        </div>
            
            `;
            $("#content").empty();
            $("#content").append(content_html);


        }

        function selectWin(id1, id2, result) {

            let idol1 = choose_member.find(idol => idol['En_Name'] == id1);
            let idol2 = choose_member.find(idol => idol['En_Name'] == id2);

            console.log(idol1, idol2, result);

            if (result == 1) {
                idol1["Point"] += 3
            }
            else if (result == 2) {
                idol2["Point"] += 3

            }
            else if (result == 0) {
                idol1["Point"] += 1
                idol2["Point"] += 1
            }
            currentMatchIndex++;
            displayMatch()

        }
        function startRound() {
            need_play_around = Math.max(1, Math.ceil(getBaseLog(2, member_choose()) + 2));
            if (round > need_play_around) {
                showRanking();
                return;
            }
            choose_member.sort((a, b) => b["Point"] - a["Point"]);
            console.log(choose_member);
            matches = [];
            let paired = new Set();

            for (let i = 0; i < choose_member.length; i++) {
                let idol1 = choose_member[i];

                if (paired.has(idol1['En_Name'])) continue;

                for (let j = i + 1; j < choose_member.length; j++) {
                    let idol2 = choose_member[j];
                    //p2這輪沒比過又沒有打過P1
                    if (!paired.has(idol2['En_Name']) && !idol1["Has_been_fight"].includes(idol2['En_Name'])) {
                        idol1["Has_been_fight"].push(idol2['En_Name']);
                        idol2["Has_been_fight"].push(idol1['En_Name']);
                        paired.add(idol1['En_Name']);
                        paired.add(idol2['En_Name']);
                        matches.push([idol1, idol2]);
                        break;
                    }
                }
            }
            console.log(paired);
            console.log(choose_member);

            let unpaired = choose_member.find(idol => !paired.has(idol["En_Name"]) && !idol['Get_Bye']);
            if (unpaired) {
                unpaired['Point'] += 2;
                unpaired['Get_Bye'] = true;  // 記錄這個人已經獲得過 bye
            }
            currentMatchIndex = 0;
            displayMatch();
        }

        function Game_start() {
            idol_list.forEach(gen => {//按下開始遊戲
                for (let index = 1; index < gen.length; index++) {

                    if ($(`#${gen[index].En_Name}`).prop('checked')) {
                        choose_member.push(
                            {
                                Name: `${gen[index].Name}`,
                                En_Name: `${gen[index].En_Name}`,
                                img: `${gen[index].Img_Path}`,
                                Point: 0,
                                Has_been_fight: []
                            }
                        );
                    }
                }
            })
            shuffle(choose_member)//打亂參賽選手陣列


            $("#initialize").hide();
            $("#startButton").hide();
            $("#content").show();
            console.log(choose_member);
            startRound();

        }
        function showRanking() {
            let ranking_html = ``;
            $("#content").hide();
            $("#result").show();
            choose_member.sort((a, b) => b["Point"] - a["Point"]);

            console.log(choose_member);
            alert(choose_member[0].En_Name)
            ranking_html += `
            <table class="table">
                <tr>
                    <th>排名</th>    
                    <th>成員</th>    
                    <th>Point</th>    
                </tr>
                `
            choose_member.forEach((mem, index) => {
                ranking_html += `
                    <tr>
                        <td>${index + 1}</td>    
                        <td>${mem.Name}</td>    
                        <td>${mem.Point}</td>    
                    </tr>
                `
            })
            ranking_html += `</table>`;
            $("#result").append(ranking_html)

        }
        function getBaseLog(x, y) {
            return Math.log(y) / Math.log(x);
        }
        /* Set the width of the sidebar to 250px and the left margin of the page content to 250px */
        function openNav() {
            document.getElementById("mySidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
        }

        /* Set the width of the sidebar to 0 and the left margin of the page content to 0 */
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
        }
    </script>
</body>

</html>